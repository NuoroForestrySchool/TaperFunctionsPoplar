---
title: "Taper Functions for poplar plantations"
output:
  pdf_document:
    toc: true
---
  
# General scope
Assessment of poplar profiles sensitivity against plantation density and competition anisotropy  
[MEMO: credo sia opportuno ricordarsi di citare
 Rubio-Cuadrado Á, Bravo-Oviedo A, Mutke S, Del Río M (2018). Climate effects on growth differ according to height and diameter
along the stem in Pinus pinaster Ait. iForest 11: 237-242. – doi: 10.3832/ifor2318-011 [online 2018-03-12]

# Setup and fetch the data

```{r read-data}
library(tidyverse)
library(magrittr)
library(ggplot2)
load(file="BasicAndTLS.Rdata")
#  OR  source("ReadData.R", echo = T)

```


# Compute diameters
(directly, not through Radius)

```{r diameters}

cooX <- TLSstem_vertical_crosssection %>% select(-Y, -Z) %>% spread(id_lato, X) %>%
  rename(
    xe1 = interfila_piena,
    xe2 = interfila_vuota,
    xa1 = intrafila_alto,
    xa2 = intrafila_basso
  )

cooY <-
  TLSstem_vertical_crosssection %>% select(-X, -Z) %>% spread(id_lato, Y) %>%
  rename(
    ye1 = interfila_piena,
    ye2 = interfila_vuota,
    ya1 = intrafila_alto,
    ya2 = intrafila_basso
  )

Diameters <- cooX %>%
  full_join(cooY) %>%
  mutate(btw_rows = sqrt((xe1 - xe2) ^ 2 + (ye1 - ye2) ^ 2),
         wti_rows = sqrt((xa1 - xa2) ^ 2 + (ya1 - ya2) ^ 2)) %>%
  select(-xe1,-xe2,-xa1,-xa2,-ye1,-ye2,-ya1,-ya2) %>%
  gather(direction, diam,-tesi,-length_toppo,-treid,-slice)

```

# Plot all profiles

```{r plot, fig.height=9, fig.width=7, eval=FALSE}
gl <- Diameters %$%
  levels(tesi) %>%
  map(
    ~ Diameters %>%
      filter(tesi == .x) %>%
      ggplot(aes(slice, diam)) +
      geom_line(aes(color = direction)) +
      facet_grid(treid ~ length_toppo, scales = "free") +
      ggtitle(paste0("Tesis: '", .x, "'")) +
      theme(plot.title = element_text(hjust = 0.5))
  )
print(gl)

```

# Calibrate taper functions

```{r}
library(TapeR)
oll <- 0.25 # Optimal Log Length
# length_toppo ottimale: compromesso tra min lag correlation e conservazione del dettaglio della forma

Diam_dec <- Diameters %>%
  filter(length_toppo == oll) %>%
  group_by(tesi, treid, direction) %>%
  mutate(tpr = diam - lead(diam,1)) %>%
  filter(tpr >= 0)
  

#define the relative knot positions and order of splines
knt_x = c(0.0, 0.1, 0.75, 1.0);	ord_x = 4 # B-Spline knots: fix effects; order (cubic = 4)
knt_z = c(0.0, 0.1       ,1.0); ord_z = 4 # B-Spline knots: rnd effects

tff <- Diam_dec %>%
  filter(length_toppo == oll) %>%
  full_join(stems_basic_measurements, by = c("tesi" = "Tesi", "treid" = "TreeId")) %>%
  mutate(Id = paste0(tesi ,treid, direction), 
         d_sez = diam *100, 
         rel_h = slice / Htot) %$%
  TapeR_FIT_LME.f(Id, d_sez, rel_h, knt_x, ord_x, knt_z, ord_z)
  #fit the model

```

